INPUT = <<-TXT
     |
     |  +--+
     A  |  C
 F---|----E|--+
     |  |  |  D
     +B-+  +--+
TXT

FINAL_INPUT = <<-TXT
               |
             +---------------------------------------------------+                 +-+         +-----+       +-------------------------------+     +-------------------------------------+         +---+
             | |                                                 |                 | |         |     |       |                               |     |                                     |         |   |
             | |         +-----+     +---------------------------|-------------------|---------+     |       |                               |     |                             +-----+ |         |   |
             | |         |     |     |                           |                 | |               |       |                               |     |                             |     | |         |   |
             +---+ +-+   |     +---+ +-----------------------------+               | +---------------+       |                         +-----------|-----------------------------|---+ +-+     +---|-+ |
               | | | |   |         |                             | |               |                         |                         |     |     |                             |   |         |   | | |
               | | +-|---+ +---+ +-|-----------------------------|-|-------------------------------------------------------+           |     |     +-------------------------------------------|---|-+ |
               | |   |     |   | | |                             | |               |                         |             |           |     |                                   |   |         |   |   |
             +---|-+ |   +-|---|-----------------------------------|-----------------------------+           +-------------|-----------|-------------------------------------------------------|-----+ |
             | | | | |   | |   | | |                             | |               |             |                         |           |     |                                   |   |         |   | | |
             | | | | |   | |   | | |             +---+   +-+     | +---------------|-----------------------------------------------+   |     |                                   |   |         |   | | |
             | | | | |   | |   | | |             |   |   | |     |                 |             |                         |       |   |     |                                   |   |         |   | | |
             +---|-|-----|-|---|-|---+           |   |   | |     | +---------------|--------------------------------P--------------|-------------------------------------------------------+   |   | | |
               | | | |   | |   | | | |           |   O   | |     | |               |             |                         |       |   |     |                                   |   |     |   |   | | |
               | | | |   | |   | | | +-----------|-------|-----------------------------------------------------------------------------------------------------------------+     |   |     |   |   | | |
               | | | |   | |   | | |             |   |   | |     | |               |             |                         |       |   |     |                             |     |   |     |   |   | | |
   +-------+   | | | |   | | +---|-|---+       +-|---+   | |     | |               |             |                         |       |   |     |                             |     |   |     |   |   | | |
   |       |   | | | |   | | | | | |   |       | |       | |     | |               |             |                         |       |   |     |                             |     |   |     |   |   | | |
   |       |   | | | |   | | | | | |   |       | |       | |     | |               |             |                         |       |   |   +-------------------+           |     |   |   +-+   |   | | |
   |       |   | | | |   | | | | | |   |       | |       | |     | |               |             |                         |       |   |   | |                 |           |     |   |   |     |   | | |
   |     +-+   | +-------|-----|-|-|---|-------------------|-----|-|-----------------------------|-------------------------|-------|---------------------------|-----------------|---|---|-+   |   | | |
   |     |     |   | |   | | | | | |   |       | |       | |     | |               |             |                         |       |   |   | |                 |           |     |   |   | |   |   | | |
   |     +-----|---|-----|-----|---|-----------|-+   +---|-|-----|-----------------|-----------------------------------------------|-------|-|-------------------------+   |   +-|---|---|-+   |   | | |
   |           |   | |   | | | M | |   |       |     |   | |     | |               |             |                         |       |   |   | |                 |       |   |   | |   |   |     |   | | |
 +-|-+     +-+ | +---|---+ | | | +---------+   |     |   | |     | |               |             |                         |       |   |   | | +---------------------+ |   |   | |   |   |     |   | | |
 | | |     | | | | | |     | | |   |   |   |   |     |   | |     | |               |             |                         |       |   |   | | |               |     | |   |   | |   |   |     |   | | |
 | | |     | | | | | |     | | |   |   |   |   |     |   | |     | |               |             |                         |       |   |   | | |               |     | |   |   | |   |   |     |   | | |
 | | |     | | | | | |     | | |   |   |   |   |     |   | |     | |               |             |                         |       |   |   | | |               |     | |   |   | |   |   |     |   | | |
 | | |     | | | | | |     | | |   |   |   |   |     |   | |     | |   +-----------|-------------|---------------------------------|-----------|-----+         | +-------------|-|-------+     |   | | |
 | | |     | | | | | |     | | |   |   |   |   |     |   | |     | |   |           |             |                         |       |   |   | | |     |         | |   | |   |   | |   |         |   | | |
 | | |     | +-|-----------|-|-|---|---|----------------S--|-----|-------------------------------|-----------------+       |       |   |   | +-------------------+   | |   |   | | +-|L----+   |   | | |
 | | |     |   | | | |     | | |   |   |   |   |     |   | |     | |   |           |             |                 |       |       |   |   |   |     |         |     | |   |   | | | |     |   |   | | |
 | | |     |   | | | |     | | | +-|-----------|-----------|-----|-----|-----------|-+           |                 |       |       +---|---|-----------+       |     | |   |   | | | |     |   |   | | |
 | | |     |   | | | |     | | | | |   |   |   |     |   | |     | |   |           | |           |                 |       |           |   |   |     | |       |     | |   |   | | | |     |   |   | | |
 | | |     |   | | | |     | | | | |   |   |   |     |   | |     | |   |           | |           |                 |       |           |   |   |     | |       |     | |   |   | | | |     |   |   | | |
 | | |     |   | | | |     | | | | |   |   |   |     |   | |     | |   |           | |           |                 |       |           |   |   |     | |       |     | |   |   | | | |     |   |   | | |
 | | |     |   | | | |     | | | | |   |   |   |     |   | |     | |   |           | |           |                 |       |           |   |   |     | |       |     | |   |   | | | |     |   |   | | |
 | | |     |   | | | |     | | | | |   |   |   |     |   | |     | |   |           | |           |                 |       |           |   |   |     | |       |     | |   |   | | | |     |   |   | | |
 | | |     +-+ | | | |     | | | | |   |   |   |     |   | |     | |   |           | |           |                 |       +-----------|---|---------|-|-------|-----|-|-------|-|-+ |     |   |   | | |
 | | |       | | | | |     | | | | |   |   |   |     |   | |     | |   |           | |           |                 |                   |   |   |     | |       |     | |   |   | |   |     |   |   | | |
 +-|-|-------|-------------|-----|-|-------|---------------------|-------------------|-----------|---------------------------------------------------|-|-------|-----+ |   |   | |   |     +---+   | | |
   | |       | | | | |     | | | | |   |   |   |     |   | |     | |   |           | |           |                 |                   |   |   |     | |       |       |   |   | |   |             | | |
   | +-+     | | | | |     | | | | |   |   |   |     |   | |     | |   |           | |           |                 |                   |   |   |     | |       |       |   |   | |   |             | | |
   |   |     | | | | |     | | | | |   |   |   |     |   | |     | |   |           | |           |                 |                   |   |   |     | |       |       |   |   | |   |             | | |
   |   |     | | | | |     | | | | |   |   |   |     |   | |     | |   |           | |           |                 |                   |   |   |     | |       |       |   |   | |   |         +-+ | | |
   |   |     | | | | |     | | | | |   |   |   |     |   | |     | |   |           | |           |                 |                   |   |   |     | |       |       |   |   | |   |         | | | | |
   |   | +-----|-+ +-|-----|---|-|---------|---|---------|-|-----------|-----------|-|-----------|-+               |       +---+       |   |   | +-------------|---------+ |   | |   |         | | | | |
   |   | |   | |     |     | | | | |   |   |   |     |   | |     | |   |           | |           | |               |       |   |       |   |   | |   | |       |       | | |   | |   |         | | | | |
   |   | |   | |     |     | | | | |   |   |   |     |   | |     | |   |           | |           | |               |       |   +-----------------|---|---------|---+   | | |   | |   |         | | | | |
   |   | |   | |     |     | | | | |   |   |   |     |   | |     | |   |           | |           | |               |       |           |   |   | |   | |       |   |   | | |   | |   |         | | | | |
   |   | |   | | +-+ |     | | | | |   |   |   |     |   | |     | |   |           | |           | |               |       |           |   |   | |   | |       |   |   | | |   | |   |         | | | | |
   |   | |   | | | | |     | | | | |   |   |   |     |   | |     | |   |           | |           | |               |       |           |   |   | |   | |       |   |   | | |   | |   |         | | | | |
   |   | |   | | | | |     | | | | |   |   |   |     |   | |     | |   |           | |           | |           +---|-------|-----------|---+   | |   | |       |   |   | | |   | |   |         | | | | |
   |   | |   | | | | |     | | | | |   |   |   |     |   | |     | |   |           | |           | |           |   |       |           |       | |   | |       |   |   | | |   | |   |         | | | | |
   |   | |   | | | | |     | | | | |   |   |   | +-----+ | |     | |   |           | |           | |     +---------|-------------------|---------|---|-|-------|---|-----|-------|---------+   | | | | |
   |   | |   | | | | |     | | | | |   |   |   | |   | | | |     | |   |           | |           | |     |     |   |       |           |       | |   | |       |   |   | | |   | |   |     |   | | | | |
   +---|-----|-----|-------|---|---+   |   |   | |   | | | |     | |   +-----+     | |           | |     |     |   +-------------------|-------|-|-----|-------|---|-----|-|---------------|-+ | | | | |
       | |   | | | | |     | | | |     |   |   | |   | | | |     | |         |     | |           | |     |     |           |           |       | |   | |       |   |   | | |   | |   |     | | | | | | |
       | |   | | | | |     | | | |     |   |   | |   | | | |     | |         |     | |           | |     |     |           |           |       | |   | |       |   |   | | |   | |   |     | | | | | | |
       | |   | | | | |     | | | |     |   |   | |   | | | |     | |         |     | |           | |     |     |           |           |       | |   | |       |   |   | | |   | |   |     | | | | | | |
     +---|---|-|-----|-----|-----+     |   |   | |   | | | |     | |   +-----|-----|-------------|-|-----------------------|-----------|-+     | |   | |       |   |   | | |   | |   |   +-|---+ | | | |
     | | |   | | | | |     | | |       |   |   | |   | | | |     | |   |     |     | |           | |     |     |           |           | |     | |   | |       |   |   | | |   | |   |   | | |   | | | |
   +---------------|---------|---------|---------|---+ | | | +-----|---------------|-------------|-|-----------|-----------|-----------+ |   +-+ |   | |       |   | +-----|-----|---|-------------+ | |
   | | | |   | | | | |     | | |       |   |   | |     | | | |   | |   |     |     | |           | |     |     |           |             |   |   |   | |       |   | | | | |   | |   |   | | |   |   | |
   | | | |   +-|-|---|-----|---|-+     |   |   | |     | | | |   | |   |   +-|-------|-------------|-----------|-----------|---------------------------|-------|---|-----|-|-----|---|---------+ |   | |
   | | | |     | | | |     | | | |     |   |   | |     | | | |   | |   |   | |     | |           | |     |     |           |             |   |   |   | |       |   | | | | |   | |   |   | | | | |   | |
   | | | |     | | | |     | | | |     |   |   | |     | | | |   | |   |   | |     | |           | |     |     |           |             |   |   |   | |       |   | | | | |   | |   |   | | +-|---+ | |
   | | | |     | | | |     | | | |     |   |   | |     | | | |   | |   |   | |     | |           | |     |     |           |             |   |   |   | |       |   | | | | |   | |   |   | |   | | | | |
   | | | |     | | | |     | | | |     |   |   | |     | | | |   | |   |   | |     | |           | |     |     |           |             |   |   |   | |       |   | | | | |   | |   |   | | +-+ | | | |
   | | | |     | | | |     | | | |     |   |   | |     | | | |   | |   |   | |     | |           | |     |     |           |             |   |   |   | |       |   | | | | |   | |   |   | | |   | | | |
   | | | |   +-|-|---|-----|-----------|-------|-------|---|-----------------|-----|-|-------------------+     |           |             |   |   |   | |       |   | | | | |   | |   |   | | |   | | | |
   | | | |   | | | | |     | | | |     |   |   | |     | | | |   | |   |   | |     | |           | |           |           |             |   |   |   | |       |   | | | | |   | |   |   | | |   | | | |
   | | | |   | | | | |     | | | |     |   |   | |     | | | |   | |   |   | |     | |           | |           |           |             |   |   |   +-|-------+   | | | | |   | |   |   | | |   | | | |
   | | | |   | | | | |     | | | |     |   |   | |     | | | |   | |   |   | |     | |           | |           |           |             |   |   |     |           | | | | |   | |   |   | | |   | | | |
   | | | |   | | | | |     | | | +-----|---|---|-------|-|---------|-----------------+           | |           |           |             |   |   |     |     +-+   | | | | |   | |   |   | | +-----+ | |
   | | | |   | | | | |     | | |       |   |   | |     | | | |   | |   |   | |     |             | |           |           |             |   |   |     |     | |   | | | | |   | |   |   | |     |   | |
   | | | |   | | | | +-+   | | |       |   |   | |     | | | |   | |   |   | |     | +-----------|-------------------------------------------------------------|-----|-|-|-|-----|---|-----|----A|-+ | |
   | | | |   | | | |   |   | | |       |   |   | |     | | | |   | |   |   | |     | |           | |           |           |             |   |   |     |     | |   | | | | |   | |   |   | |     | | | |
   | | | |   | | | |   |   | | |       |   |   | |     | | | |   | |   |   | |     | |           | |           |           |             |   |   |     |     | |   | | | | |   | |   |   | |     | | | |
   | | | |   | | | |   |   | | |       |   |   | |     | | | |   | |   |   | |     | |           | |           |           |             |   |   |     |     | |   | | | | |   | |   |   | |     | | | |
   | | | |   | | | |   |   +---|-----+ |   |   | |     | | | |   | |   |   | |     | |           +-|-----------|-------------------------|-------|-----------------------|-|-------------|-+     | | | |
   | | | |   | | | |   |     | |     | |   |   | |     | | | |   | |   |   | |     | |             |           |           |             |   |   |     |     | |   | | | | |   | |   |   |       | | | |
   | | | |   | | | |   |     | |     | |   |   | |     | | | |   | |   |   | |     | |             |           |           |             |   |   |     |     | |   | | | | |   | |   |   |       | | | |
   | | | |   | | | |   |     | |     | |   |   | |     | | | |   | |   |   | |     | |             |           |           |             |   |   |     |     | |   | | | | |   | |   |   |       | | | |
 +---|-|-|---|-----|---|-------|-----|-----|-----|-----|---|-|---|-----------------|-|-----------------------------------------------------------+     |     | |   | | | | |   | |   |   |       | | | |
 | | | | |   | | | |   |     | |     | |   |   | |     | | | |   | |   |   | |     | |             |           |           |             |   |         |     | |   | | | | |   | |   |   |       | | | |
 | | | | |   | | | |   |     | |     | |   |   | |     | | | |   | |   |   | |     | |             |           |           |             |   |         |     | |   | | | | |   | |   |   |       | | | |
 | | | | |   | | | |   |     | |     | |   |   | |     | | | |   | |   |   | |     | |             |           |           |             |   |         |     | |   | | | | |   | |   |   |       | | | |
 | | | | |   | | | |   |     | |     | |   |   | |     | | | |   | |   |   | |     | |             |           |           |             |   |         |     | |   | | | | |   | |   |   |       | | | |
 | | | | |   | | | |   |     | |     | |   |   | |     | | | |   | |   |   | |     | |             |           |           |             |   |         |     | |   | | | | |   | |   |   |       | | | |
 | | | | |   | | | | +---------------------------|-----|---|-|-----|---|---|-------|-|-------------------------+           |             |   |         |     | |   | | | | |   | |   |   |       | | | |
 | | | | |   | | | | | |     | |     | |   |   | |     | | | |   | |   |   | |     | |             |                       |             |   |         |     | |   | | | | |   | |   |   |       | | | |
 | | +-|-|---|---------------|-|-----------|-----|-------|---|---------|-----------|---------------------------------------------------------|---------|-----|-------|-+ | |   | |   |   |       | | | |
 | |   | |   | | | | | |     | |     | |   |   | |     | | | |   | |   |   | |     | |             |                       |             |   |         |     | |   | |   | |   | |   |   |       | | | |
 | +-----|---+ | | +-|---+   | | +---|-|---|-+ | |     | | | |   | |   |   | |     | |     +-------|-------------------------------------|---|---------------|-|---|-|---------|-|---|---|-------|-|-|-+
 |     | |     | |   | | |   | | |   | |   | | | |     | | | |   | |   |   | |     | |     |       |                       |             |   |         |     | |   | |   | |   | |   |   |       | | |
 | +---|---+ +-+ +---|-|-|---|-|-----|-----|---|-----------|-|---|-----|-+ | |     | |     |       |           +-------------------------|-------------|-----|-|---|-----------------|---|-------|-|-+
 | |   | | | |       | | |   | | |   | |   | | | |     | | | |   | |   | | | |     | |     |       |           |           |             |   |         |     | |   | |   | |   | |   |   |       | |
 | |   | | | |       | | |   | | |   | |   | | | |     | | | |   | |   | +---|---------------------|-------------------------------------|-------------------|-|---|-------|-+ | |   |   |       | |
 | |   | | | |       | | |   | | |   | |   | | | |     | | | |   | |   |   | |     | |     |       |           |           |             |   |         |     | |   | |   | | | | |   |   |       | |
 | |   | | | |       | | |   | | |   | |   | | | |     | | | |   | |   | +-----------|-------------|-------------------------------------|---|-----------------|-----|---|---|-|-----|---|-------|-----+
 | |   | | | |       | | |   | | |   | |   | | | |     | | | |   | |   | | | |     | |     |       |           |           |             |   |         |     | |   | |   | | | | |   |   |       | |   |
 | |   | | | |       | | | +-----|---|-|-----|-|-|-----|---|-----|-------|---------------------+   |           |           |             |   |         |     | |   | |   | | | | |   |   |       | |   |
 | |   | | | |       | | | | | | |   | |   | | | |     | | | |   | |   | | | |     | |     |   |   |           |           |             |   |         |     | |   | |   | | | | |   |   |       | |   |
 | |   | | +-----------------|---------|---------|-------|-|-|---|-|---------|-----|-|---------|---|-----------|-----------|-----------------|---------|-------|---|-----|---|-|-|---|-------+   | |   |
 | |   | |   |       | | | | | | |   | |   | | | |     | | | |   | |   | | | |     | |     |   |   |           |           |             |   |         |     | |   | |   | | | | |   |   |   |   | |   |
 | |   | |   |       | | | | | | |   | |   | | | |     | | | |   | |   | | | |     | |     |   |   |           |           |             |   |         |     | |   | |   | | | | |   |   |   |   +---+ |
 | |   | |   |       | | | | | | |   | |   | | | |     | | | |   | |   | | | |     | |     |   |   |           |           |             |   |         |     | |   | |   | | | | |   |   |   |     | | |
 | |   | |   |       | | | | | | |   | |   | | | |     | | | |   | |   | | | |     | |     |   |   |           |           |             |   |         |     | |   | |   | | | | |   |   |   |     | | |
 | |   | |   |       | | | | | | |   | |   | | | |     | | | |   | |   | | | |     | |     |   |   |           |           |             |   |         |     | |   | |   | | | | |   |   |   |     | | |
 | +---|-|---|---------|-|-|---|-----|-----------|-------+ | |   | |   | | | |     | |     |   +---|-----------------------|---------------------------|-----|-----|-|---|-+ | | |   |   |   |     | | |
 |     | |   |       | | | | | | |   | |   | | | |     |   | |   | |   | | | |     | |     |       |           |           |             |   |         |     | |   | |   |   | | |   |   |   |     | | |
 |     | | +-----------+ | | | | |   | |   | | | |     |   | |   | |   | | | |     +-|-----|-------------------|---------+ |             |   |         |     | |   | |   |   | | |   |   |   |     | | |
 |     | | | |       |   | | | | |   | |   | | | |     |   | |   | |   | | | |       |     |       |           |         | |             |   |         |     | |   | |   |   | | |   |   |   |     | | |
 |     | | | |       |   | | | | |   | |   | | | |     |   | |   | |   | | | | +-----------|---------------------------------------------|---|---------|-----------|-----+   | | |   |   | +-|-----|---+
 |     | | | |       |   | | | | |   | |   | | | |     |   | |   | |   | | | | |     |     |       |           |         | |             |   |         |     | |   | |       | | |   |   | | |     | |
 |     | | | |       |   | | | | |   | |   | | | |     |   | |   | |   | | | | |     |     |       |           | +-------|---------------|-------------+     | |   | |       | | |   |   | | |     | |
 |     | | | |       |   | | | | |   | |   | | | |     |   | |   | |   | | | | |     |     |       |           | |       | |             |   |               | |   | |       | | |   |   | | |     | |
 |     | | | |       |   | | | | |   | |   +-|-------+ |   | |   | |   | | | | |     |   +-|-------|-----------|-----------|-------------|-------------------|-|-----|-----------|-------|-------+ | |
 |     | | | |       |   | | | | |   | |     | | |   | |   | |   | |   | | | | |     |   | |       |           | |       | |             |   |               | |   | |       | | |   |   | | |   | | |
 |     | | | |       |   | | | | |   | |     | | |   | +---+ +---|-----|-|---|-+ +---|---|-|-----+ |           | +---------|-------------|---------+         | |   | |       | | |   |   | | |   | | |
 |     | | | |       |   | | | | |   | |     | | |   |           | |   | | | |   |   |   | |     | |           |         | |             |   |     |         | |   | |       | | |   |   | | |   | | |
 |     | | | |       |   | +-|-+ |   | |     | | |   +-----------|-|-----|---|-------|---|-|-------|---------------------+ |             |   |     |     +---|-------|-+     | | |   |   | | |   | | |
 |     | | | |       |   |   |   |   | |     | | |               | |   | | | |   |   |   | |     | |           |           |             |   |     |     |   | |   | | |     | | |   |   | | |   | | |
 |     | | | |   +---+ +-|---|-+ |   | |     | | |   +-----------|---+ | | | |   |   |   | |     | |           |           |             |   |     |     |   | |   | | |   +-|-----------------------|-+
 |     | | | |   |     | |   | | |   | |     | | |   |           | | | | | | |   |   |   | |     | |           |           |             |   |     |     |   | |   | | |   | | | |   |   | | |   | | | |
 |     | | | |   +---------+ | +-------|-----|-+ |   |           | | | | | | |   |   |   | |     | |           |           |             |   |     |     |   | |   | | |   | | | |   |   | | |   | | | |
 |     | | | |         | | | |   |   | |     |   |   |           | | | | | | |   |   |   | |     | |           |           |             |   |     |     |   | |   | | |   | | | |   |   | | |   | | | |
 | +-----|-|-------------|-|-|---|---|-------|-------|-+         | | | | | | |   |   |   | | +-----+         +---+         |             |   +-+   |     |   | |   | | |   | +-------------|-+   | | | |
 | |   | | | |         | | | |   |   | |     |   |   | |         | | | | | | |   |   |   | | |   |           | | |         |             |     |   |     |   | |   | | |   |   | |   |   | |     | | | |
 | |   | | +-|---------|---|-|---|---|-|-----|---------|---------------|-|-----+ | +-|---+ | | +-------------|-------------|-------------|-------------------|-----|-+ +---|-+ | |   |   | |     | | | |
 | |   | |   |         | | | |   |   | |     |   |   | |         | | | | | | | | | | |     | | | |           | | |         |             |     |   |     |   | |   |       | | | |   |   | |     | | | |
 | |   | |   |         | | | |   |   | |     |   |   | |         | | | | | | | | | | |     | | | |           | | +---------|-----------------------|-----|---|-|---|---+   | | | |   |   | |     | | | |
 | |   | |   |         | | | |   |   | |     |   |   | |         | | | | | | | | | | |     | | | |           | |           |             |     |   |     |   | |   |   |   | | | |   |   | |     | | | |
 | |   | |   |         | | | |   |   | |     |   |   | +-----------+ | | | | | | | | |     | | | |           | |         +---------------------|---|---------|-|-------------|-|---------|-|-----+ | | Y
 | |   | |   |         | | | |   |   | |     |   |   |           |   | | | | | | | | |     | | | |           | |         | |             |     |   |     |   | |   |   |   | | | |   |   | |       | |
 | |   | |   |         | | | |   |   | |     |   |   +---------------|---|-|-----|-----------|-----------------|---------|---------------------|---|-----|-----|---|-------|-+ | |   |   | +-----+ | |
 | |   | |   |         | | | |   |   | |     |   |               |   | | | | | | | | |     | | | |           | |         | |             |     |   |     |   | |   |   |   |   | |   |   |       | | |
 | |   | | +-----------|-|-----+ |   | |     |   +---------------------|-|-|---+ | +---------------------------|---------|---------------|---------------------------------------------------------|-|-+
 | |   | | | |         | | | | | |   | |     |                   |   | | | | |   |   |     | | | |           | |         | |             |     G   |     |   | |   |   |   |   | |   |   |       | | | |
 | |   | +---|---------|---|---|-------|---------------------------------------------|-----|---|-|-----------------------|-|-------------|-----|---------|---|-------+ |   | +-------------+     | | | |
 | |   |   | |         | | | | | |   | |     |                   |   | | | | |   |   |     | | | |           | |         | |             |     |   |     |   | |   | | |   | | | |   |   | |     | | | |
 | |   |   | |         | | | | | |   | |     |                   |   | | | | |   |   |     | | | |           | |         | |       +-----|---------|-----+   | |   | +-|-----+ | |   |   | |     | | | |
 | |   |   | |         | | | | | |   | |     |                   |   | | | | |   |   |     | | | |           | |         | |       |     |     |   |         | |   |   |   |   | |   |   | |     | | | |
 | | +-|---+ |         +-|---|-------|-|-------------------------------|-|---|---|---|---+ | | | |           | |         | |       |     |     |   |   +-+   | |   +-------------|---|-------+   | | | |
 | | | |     |           | | | | |   | |     |                   |   | | | | |   |   |   | | | | |           | |         | |       |     |     |   |   | |   | |       |   |   | |   |   | | |   | | | |
 | | | |     |           | | | | |   | |     |                   |   | | | | |   |   |   | | | | |           | |     +---|-|---+   | +---|---------|---------------+   |   |   | |   |   | | |   | | | |
 | | | |     |           | | | | |   | |     |                   |   | | | | |   |   |   | | | | |           | |     |   | |   |   | |   |     |   |   | |   | |   |   |   |   | |   |   | | |   | | | |
 | | | |   +---------------|-|---------------|-------------------|---|-|-|-|-|---|---|---|-|-|-|-|-------------------+   | |   |   | |   |     |   |   | +---+ |   |   |   | +---|---|-----|-+   | | | |
 | | | |   | |           | | | | |   | |     |                   |   | | | | |   |   |   | | | | |           | |         | |   |   | |   |     |   |   |       |   |   |   | | | |   |   | |     | | | |
 | | | |   | |           | | | | |   | |     |                   |   | | | | |   |   |   | | | | |           | |         | |   |   | |   |     |   |   |       |   |   |   | | | |   |   | |     | | | |
 | | | |   | |           | | | | |   | |     |                   |   | | | | |   |   |   | | | | |           | |         | |   |   | |   |     |   |   |       |   |   |   | | | |   |   | |     | | | |
 | | | |   | |           | | | | |   | |     |     +-------------|---|-|---------|-+ |   | | | | |           | |         | |   |   | |   |     |   |   |       |   |   |   | | | |   |   | |     | | | |
 | | | |   | |           | | | | |   | |     |     |             |   | | | | |   | | |   | | | | |           | |         | |   |   | |   |     |   |   |       |   |   |   | | | |   |   | |     | | | |
 +-+ | |   +-------------------|-----|-------|-----|-------------+   | | | | |   | | |   | | | | |           +-----------------|---|-|---+     |   |   |       |   |   |   | | | |   |   | |     | | | |
     | |     |           | | | | |   | |     |     |                 | | | | |   | | |   | | | | |             |         | |   |   | |         |   |   |       |   |   |   | | | |   |   | |     | | | |
 +---+ |     |           | | | | |   | |     |     |                 | | | | |   | | |   | | | | |             |         | |   +-------------+ |   |   |       |   |   |   | | | |   |   | |     | | | |
 |     |     |           | | | | |   | |     |     |                 | | | | |   | | |   | | | | |             |         | |       | |       | |   |   |       |   |   |   | | | |   |   | |     | | | |
 |     |     |     +---+ | | | | |   | |     |     |                 | | | | |   | | |   | | | | |             |         | |       | |       | |   |   |       |   |   +-----|-|-|-----+ | | +-------+ |
 |     |     |     |   | | | | | |   | |     |     |                 | | | | |   | | |   | | | | |             |         | |       | |       | |   |   |       |   |       | | | |   | | | | |   | |   |
 +-----|---------+ |   | | +-----|---|-------|-----|-----------------|-|-----------------+ +---|---------------+         | |       | |       | |   |   +-------|---|-------|-|-------|-|---|-+   | |   |
       |     |   | |   | |   | | |   | |     |     |                 | | | | |   | | |       | | |                       | |       | |       | |   |           |   |       | | | |   | | | |     | |   |
       |     |   | |   | |   | | |   +-------------|-------------+   | | | +-|---|-+ |       | | |                       | |       | |       | |   |           |   |   +---+ | | |   | | | | +-+ | |   |
       |     |   | |   | |   | | |     |     |     |             |   | | |   |   |   |       | | J                       | |       | |       | |   |           |   |   |     | | |   | | | | | | | |   |
       |     |   | |   | +-------------|-----------+             |   | | |   |   |   |       | | |                       | |       | |       | +---|---+       |   |   |     | | |   | | | | | | | |   |
       |     |   | |   |     | | |     |     |                   |   | | |   |   |   |       | | |                       | |       | |       |     |   |       |   |   |     | | |   | | | | | | | |   |
       |     |   | |   |     | | |     |     |                   |   | | |   |   |   |       | | |       +---+           | |       | |       |     |   |       |   |   |     | | |   | | | | | | | |   |
       |     |   | |   |     | | |     |     |                   |   | | |   |   |   |       | | |       |   |           | |       | |       |     |   |       |   |   |     | | |   | | | | | | | |   |
       |     |   | |   |     | | |     |     |                   |   | | |   |   |   |       | | |       |   |           | |       | |       |     |   |       |   |   |     | | |   | | | | | | | |   |
       |     |   | |   |     | | |     |     |                   |   | | |   |   |   |       | | |       |   |           | |       | |       |     |   |       |   |   |     | | |   | | | | | | | |   |
       |     |   | |   |     | | |     |     |                   |   | | |   |   |   |       | | |       |   |           | |       | |       |     |   |       |   |   |     | | |   | | | | | | | |   |
       |     |   | |   |     | | |     |     |                   |   | | |   |   |   |       | | |       |   |           | |       | |       |     |   |       |   |   |     | | |   | | | | | | | |   |
       |     |   | |   |     +-+ |     |     |         +---------|---|-|-|-------|---|-------|-|---------|---|---------------------|---------|-----|---------------|-----------|-----+ +---------|-+   |
       |     |   | |   |         |     |     |         |         |   | | |   |   |   |       | | |       |   |           | |       | |       |     |   |       |   |   |     | | |       | | | | |     |
       |     |   | |   |         |     |     |         |         |   | | |   +-------|-------|---|-----+ |   |           +-|-----------------|-----+   +-----------|---|-----|-+ |       | | | | |     |
       |     |   | |   |         |     |     |         |         |   | | |       |   |       | | |     | |   |             |       | |       |                 |   |   |     |   |       | | | | |     |
       +-----|---------|---------+     +-----------------------------+ | |   +---|-+ |       | +-|-----|-----|-------------|---------|-------+                 |   |   |     |   |       | | | | |     |
             |   | |   |                     |         |         |     | |   |   | | |       |   |     | |   |             |       | |                         |   |   |     |   |       | | | | |     |
             |   | |   |                     |         |         |     | |   |   | | |       |   |     | |   |             |       | |                         |   +---+     |   |     +---+ | | | +---+
             |   | |   |                     |         |         |     | |   |   | | |       |   |     | |   |             |       | |                         |             |   |     | |   | | | |
       +---------+ |   |                     |         |         |     | |   |   | | |       |   |     +-|---|-------------|-------|-+                         |             |   |   +-+ |   | +-|---+
       |     |     |   |                     |         |         |     | |   |   | | |       |   |       |   |             |       |                           |             |   |   |   |   |   | | |
       |     |     |   |                     |         |         |     | |   +-------|-------|---------------|-------------|---------+                         |             |   |   |   |   |   | | |
       |     |     |   |                     |         |         |     | |       | | |       |   |       |   |             |       | |                         |             |   |   |   |   |   | | |
       | +---+     |   |                     |         |         +-----|-|-------|-|---------|-----------|-------------------------|-----------------------------------------+ +-+   |   +---|-----|-+
       | |         |   |                     |         |               | |       | | |       |   |       |   |             |       | |                         |               |     |       |   | |
       | +-----------------------------------|---------|---------+     | +-------|---+       |   |       |   |             +-------|---------------------------+         +-----------|-------+   +-+
       |           |   |                     |         |         |     |         | |         |   |       |   |                     | |                                   |     |     |
       |           +-----------------------------------+         |     |     +---+ |         +-----------+ +-----------------------|-------------------------------------------+     +-------+
       |               |                     |                   |     |     |     |             |         | |                     | |                                   |                   |
       |               |                   +---------------------|-----------|-----------------------------|-------------------------|-----------------------------------+                   +-------+
       |               |                   | |                   |     |     |     |             |         | |                     | |                                                               |
 +-----+               +-------------------|---------------------------+ +---------------------------------|-|-----------------------|-----------------------------------------------------+         |
 |                                         | |                   |       |   |     |             |         | |                     | |                                                     |         |
 |                 +-------------------------|-------------------|-------|---|-----+             |         | |                     | |                                                     |         |
 |                 |                       | |                   |       |   |                   |         | |                     | |                                                     |         |
 |                 |                     +---|-------------------|-----------|-----------------------------+ +---------------------+ |                                                     |   +-----+
 |                 |                     | | |                   |       |   |                   |                                   |                                                     |   |
 +-----------------+                     +-+ +-------------------+       +---+                   +-----------------------------------+                                                     +---+

TXT


maze = []
FINAL_INPUT.each_line do |line|
  maze << line.chars - ["\n"]
end

dir = :s
char = "|"
px = 0
py = maze[0].index(char)

collection = []
still_collecting = true
steps = -1

while still_collecting do
  steps += 1
  char = maze[px][py]
  case char
  when /[A-Z]/
    collection << char
    case dir
    when :n then px -= 1
    when :e then py += 1
    when :s then px += 1
    when :w then py -= 1
    end
  when "|", "-"
    if [:n, :s].include?(dir)
      px = dir == :n ? px - 1 : px + 1
    else
      py = dir == :w ? py - 1 : py + 1
    end
  when "+"
    if [:n, :s].include?(dir)
      dir = maze[px][py + 1].nil? || maze[px][py + 1] == " " ? :w : :e
      py = dir == :w ? py - 1 : py + 1
    else
      dir = maze[px - 1][py].nil? || maze[px - 1][py] == " " ? :s : :n
      px = dir == :n ? px - 1 : px + 1
    end
  else
    still_collecting = false
  end
end

# Part 1
p collection.join
# Part 2
p steps
